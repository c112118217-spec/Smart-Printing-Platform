<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Mirror - Pro Health System (Responsive Final)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-cyan': '#22d3ee',
                        'status-safe': '#10b981',
                        'status-warning': '#f59e0b',
                        'status-danger': '#ef4444',
                        'bg-dark': '#020617'
                    },
                    animation: {
                        'scan-line': 'scan-move 3s linear infinite',
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: "Microsoft JhengHei", ui-sans-serif, system-ui; background-color: #020617; color: white; overflow-x: hidden; }
        .glass-panel { background-color: rgba(15, 23, 42, 0.7); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .nav-btn-active { background-color: rgba(30, 41, 59, 0.5); border: 1px solid #475569; border-radius: 0.5rem; color: #22d3ee; }
        .nav-btn-inactive { color: #94a3b8; border: 1px solid transparent; }
        .nav-btn-inactive:hover { color: white; background-color: rgba(30, 41, 59, 0.3); }
        .data-font { font-family: 'Courier New', monospace; font-weight: 700; }
        input, select, textarea { background-color: #0f172a !important; border: 1px solid #1e293b !important; color: white !important; border-radius: 0.5rem; padding: 0.75rem; width: 100%; outline: none; transition: border-color 0.2s; }
        input:focus, select:focus, textarea:focus { border-color: #22d3ee !important; }
        .lang-btn { padding: 0.25rem 0.75rem; font-size: 0.875rem; border-radius: 0.25rem; border: 1px solid; transition: all 0.2s; font-weight: bold; }
        .lang-btn-active { background-color: white; color: black; border-color: white; }
        .lang-btn-inactive { border-color: #475569; color: #94a3b8; }
        .range-btn-active { background-color: #22d3ee !important; color: #020617 !important; font-weight: bold; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        @keyframes scan-move { 0% { top: 0%; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
        .animate-scan-line { position: absolute; animation: scan-move 3s linear infinite; }
        video { transform: scaleX(-1); }
    </style>
</head>
<body class="min-h-screen">

    <div id="app" class="flex flex-col md:flex-row h-screen p-2 md:p-4 gap-4 max-w-[1800px] mx-auto">

        <section id="login-view" class="fixed inset-0 z-[3000] bg-slate-950 flex items-center justify-center overflow-y-auto p-4">
            <div id="login-card" class="glass-panel p-6 md:p-10 w-full max-w-md text-center border-t-4 border-primary-cyan shadow-2xl relative">
                <i class="fas fa-heart-pulse text-5xl md:text-6xl text-primary-cyan mb-6 animate-pulse"></i>
                <h1 data-i18n="login_title" class="text-2xl md:text-3xl font-bold mb-2">智慧鏡健康監測</h1>
                <p data-i18n="login_subtitle" class="text-slate-400 mb-8 text-sm">心肌梗塞預防 & 水腫程度分析</p>

                <div id="login-form" class="space-y-4">
                    <input type="text" id="login-user" data-i18n-placeholder="login_user_placeholder" placeholder="帳號 ID">
                    <input type="password" id="login-pass" data-i18n-placeholder="p_ps" placeholder="密碼">
                    <div class="flex justify-end"><button onclick="openRecoveryModal()" class="text-slate-500 text-xs hover:text-primary-cyan hover:underline" data-i18n="login_forgot">忘記密碼？</button></div>
                    <button onclick="handleLogin()" data-i18n="login_btn" class="w-full bg-primary-cyan text-slate-900 font-bold py-3 rounded-lg hover:bg-cyan-400 transition-all shadow-lg">登入系統</button>
                    <p class="text-slate-500 text-sm mt-6"><span data-i18n="no_acc">還沒有帳號？</span> <button onclick="toggleLoginRegister(true)" class="text-primary-cyan font-bold hover:underline" data-i18n="login_create_btn">建立帳號</button></p>
                </div>

                <div id="register-form" class="hidden space-y-3 text-left">
                    <input type="text" id="reg-id" data-i18n-placeholder="set_uid" placeholder="設定帳號 ID">
                    <input type="password" id="reg-pass" data-i18n-placeholder="set_ps" placeholder="設定密碼">
                    <input type="text" id="reg-name" data-i18n-placeholder="p_nm" placeholder="姓名">
                    <div class="grid grid-cols-2 gap-2">
                        <select id="reg-gender"><option value="male" data-i18n="opt_male">男</option><option value="female" data-i18n="opt_female">女</option></select>
                        <input type="date" id="reg-birth">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="number" id="reg-height" data-i18n-placeholder="p_ht" placeholder="身高 (cm)">
                        <input type="number" id="reg-weight" data-i18n-placeholder="p_wt" placeholder="體重 (kg)">
                    </div>
                    <button onclick="handleRegister()" class="w-full bg-emerald-500 text-white font-bold py-3 rounded-lg mt-4" data-i18n="reg_complete_btn">完成註冊並登入</button>
                    <button onclick="toggleLoginRegister(false)" class="w-full text-slate-400 text-sm py-2 hover:text-white text-center" data-i18n="reg_back_btn">返回登入</button>
                </div>
            </div>
        </section>

        <div class="md:hidden glass-panel p-4 flex justify-between items-center shrink-0">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-full bg-cyan-400 text-slate-900 flex items-center justify-center font-bold text-xs">SM</div>
                <span id="display-name-mobile" class="font-bold text-sm">--</span>
            </div>
            <button onclick="toggleMobileMenu()" class="text-primary-cyan"><i class="fas fa-bars text-xl"></i></button>
        </div>

        <aside id="main-sidebar" class="hidden md:flex w-72 glass-panel p-6 flex-col shrink-0">
            <div class="flex flex-col items-center mb-10 border-b border-white/10 pb-8 text-center">
                <div id="user-avatar" class="w-20 h-20 rounded-full bg-cyan-400 flex items-center justify-center text-slate-900 font-bold text-3xl mb-4 shadow-[0_0_20px_rgba(34,211,238,0.5)]">SM</div>
                <h2 id="display-name" class="text-2xl font-bold mb-1 truncate w-full px-2">--</h2>
                <p id="display-id" class="text-sm text-slate-500">ID: --</p>
            </div>
            <nav id="sidebar-nav" class="flex-1 space-y-4"></nav>
            <button onclick="logout()" class="mt-auto p-4 text-slate-500 hover:text-red-400 flex items-center gap-3 transition-colors rounded-lg hover:bg-white/5">
                <i class="fas fa-sign-out-alt"></i> <span data-i18n="nav_logout">登出系統</span>
            </button>
        </aside>

        <main class="flex-1 flex flex-col overflow-y-auto no-scrollbar relative p-1 md:p-2">
            <header class="flex flex-col sm:flex-row justify-between items-start mb-6 px-2 pt-2 gap-4">
                <div class="flex flex-col">
                    <h1 id="page-title-header" class="text-xl md:text-2xl font-bold tracking-wider" data-i18n="dash_header">健康狀態總覽</h1>
                    <span id="role-badge" class="mt-1 w-fit bg-slate-800 px-2 py-0.5 rounded text-[10px] text-slate-400 font-bold uppercase tracking-widest">User</span>
                </div>
                <div class="flex flex-row md:flex-col items-center md:items-end gap-3 w-full sm:w-auto">
                    <span class="text-slate-400 text-xs md:text-sm font-medium"><i class="far fa-clock mr-1"></i> <span id="clock-display">--:--</span></span>
                    <div class="flex gap-2 ml-auto sm:ml-0">
                        <button onclick="setLanguage('zh')" id="btn-zh" class="lang-btn lang-btn-active text-[10px] md:text-xs">中文</button>
                        <button onclick="setLanguage('en')" id="btn-en" class="lang-btn lang-btn-inactive text-[10px] md:text-xs">English</button>
                    </div>
                </div>
            </header>

            <section id="view-dashboard" class="subview space-y-6">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
                    <div class="glass-panel p-6 md:p-8 relative overflow-hidden bg-slate-900/40 min-h-[200px] md:min-h-[240px]">
                        <p class="text-cyan-400 text-[10px] md:text-xs font-bold tracking-widest mb-1">RISK ASSESSMENT</p>
                        <h3 class="text-xl md:text-2xl font-bold mb-4 md:mb-6" data-i18n="mi_risk_title">心肌梗塞風險</h3>
                        <span id="dash-mi-value" class="text-6xl md:text-7xl font-bold text-slate-600 data-font">--</span>
                    </div>
                    <div class="glass-panel p-6 md:p-8 relative overflow-hidden bg-slate-900/40 min-h-[200px] md:min-h-[240px]">
                        <p class="text-amber-500 text-[10px] md:text-xs font-bold tracking-widest mb-1 uppercase">Edema Monitor</p>
                        <h3 class="text-xl md:text-2xl font-bold mb-4 md:mb-6" data-i18n="edema_title">肢體水腫等級</h3>
                        <span id="dash-edema-value" class="text-6xl md:text-7xl font-bold text-slate-600 data-font">--</span>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-2 md:gap-6 text-center">
                    <div class="glass-panel p-3 md:p-6 bg-slate-900/30">
                        <p class="text-slate-500 text-[9px] md:text-xs font-bold mb-1 uppercase" data-i18n="th_hr">HR</p>
                        <p id="dash-hr" class="text-lg md:text-3xl font-bold data-font">--</p>
                    </div>
                    <div class="glass-panel p-3 md:p-6 bg-slate-900/30">
                        <p class="text-slate-500 text-[9px] md:text-xs font-bold mb-1 uppercase">HRV</p>
                        <p id="dash-hrv" class="text-lg md:text-3xl font-bold data-font text-primary-cyan">--</p>
                    </div>
                    <div class="glass-panel p-3 md:p-6 bg-slate-900/30">
                        <p class="text-slate-500 text-[9px] md:text-xs font-bold mb-1 uppercase" data-i18n="th_bp">BP</p>
                        <p id="dash-bp" class="text-lg md:text-3xl font-bold data-font">--</p>
                    </div>
                </div>

                <button onclick="startCamera()" class="w-full glass-panel py-4 md:py-6 border-cyan-500/30 bg-cyan-500/10 text-primary-cyan font-bold text-lg md:text-2xl hover:bg-cyan-500/20 transition-all flex items-center justify-center gap-4 group">
                    <i class="fas fa-camera-retro text-xl md:text-3xl"></i><span data-i18n="start_scan_btn">啟動 AI 鏡像檢測</span>
                </button>

                <button onclick="triggerSOS()" class="w-full glass-panel py-6 md:py-8 border-red-500/30 bg-red-500/5 text-red-500 font-bold text-xl md:text-3xl shadow-lg hover:shadow-red-500/30 transition-all">
                    <i class="fas fa-exclamation-triangle mr-4 animate-bounce"></i><span data-i18n="sos_btn">SOS</span>
                </button>
            </section>

            <section id="view-history" class="subview hidden space-y-6">
                <div class="flex justify-between items-center mb-6 px-2"><h2 class="text-xl md:text-2xl font-bold border-l-4 border-primary-cyan pl-3" data-i18n="history_header">生理數據追蹤</h2></div>
                
                <div class="glass-panel p-4 flex flex-col lg:flex-row gap-4 justify-between">
                    <div class="flex flex-wrap gap-2" id="range-selector">
                        <button onclick="applyTimeRange(7, this)" class="px-3 py-1.5 text-[10px] md:text-xs rounded bg-slate-800" data-i18n="range_1w">1W</button>
                        <button onclick="applyTimeRange(30, this)" class="px-3 py-1.5 text-[10px] md:text-xs rounded bg-slate-800 range-btn-active" data-i18n="range_1m">1M</button>
                        <button onclick="toggleCustomUI()" class="px-3 py-1.5 text-[10px] md:text-xs rounded bg-slate-800" data-i18n="btn_custom">Custom</button>
                    </div>
                    <div id="custom-date-wrap" class="hidden flex items-center gap-2">
                        <input type="date" id="start-date" class="!py-1 !px-2 !text-[10px] !w-28 md:!w-36">
                        <input type="date" id="end-date" class="!py-1 !px-2 !text-[10px] !w-28 md:!w-36">
                        <button onclick="applyCustomDate()" class="bg-primary-cyan text-slate-900 px-3 py-1 rounded text-[10px] font-bold">OK</button>
                    </div>
                </div>

                <div class="glass-panel p-2 md:p-6 h-[300px] md:h-96"><canvas id="historyChart"></canvas></div>

                <div class="glass-panel overflow-x-auto">
                    <table class="w-full text-left text-xs md:text-sm">
                        <thead class="bg-slate-800 text-primary-cyan uppercase font-bold">
                            <tr><th class="p-3 md:p-4" data-i18n="th_date">Date</th><th class="p-3 md:p-4" data-i18n="th_mi">MI %</th><th class="p-3 md:p-4" data-i18n="th_edema">Level</th><th class="p-4">HR</th><th class="p-4">HRV</th><th class="p-4">BP</th></tr>
                        </thead>
                        <tbody id="history-table-body" class="divide-y divide-slate-800"></tbody>
                    </table>
                </div>
            </section>

            <section id="view-profile" class="subview hidden space-y-6">
                <div class="flex items-center gap-3 mb-4 px-2"><i class="fas fa-id-card text-2xl text-cyan-400"></i><h1 class="text-2xl md:text-3xl font-bold" data-i18n="profile_header">使用者檔案</h1></div>
                <div class="glass-panel p-6 md:p-10 bg-slate-900/40">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-10">
                        <div><label class="text-slate-500 text-xs mb-2 block" data-i18n="prof_name">姓名</label><input type="text" id="prof-name"></div>
                        <div><label class="text-slate-500 text-xs mb-2 block" data-i18n="prof_gender">性別</label><select id="prof-gender"><option value="male" data-i18n="opt_male">男</option><option value="female" data-i18n="opt_female">女</option></select></div>
                        <div><label class="text-slate-500 text-xs mb-2 block" data-i18n="p_ht">身高 (cm)</label><input type="number" id="prof-height"></div>
                        <div><label class="text-slate-500 text-xs mb-2 block" data-i18n="p_wt">體重 (kg)</label><input type="number" id="prof-weight"></div>
                        <div class="md:col-span-2"><label class="text-slate-500 text-xs mb-2 block" data-i18n="prof_birth">生日</label><input type="date" id="prof-birth"></div>
                    </div>
                    
                    <div class="flex justify-center mt-10">
                        <button onclick="saveProfile()" class="w-full md:w-64 bg-primary-cyan text-slate-900 font-bold py-4 rounded-xl text-lg hover:bg-cyan-400 shadow-xl transition-transform active:scale-95" data-i18n="btn_save">儲存基本資料</button>
                    </div>

                    <div class="pt-10 mt-10 border-t border-slate-800 flex flex-col md:flex-row justify-center gap-4 md:gap-10">
                        <button onclick="openAuthModal('id')" class="text-slate-400 text-xs hover:text-white underline" data-i18n="btn_change_id">更改使用者 ID</button>
                        <button onclick="openAuthModal('pass')" class="text-slate-400 text-xs hover:text-white underline" data-i18n="btn_change_ps">更改登入密碼</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="auth-modal" class="hidden fixed inset-0 z-[5000] bg-black/90 backdrop-blur-md flex items-center justify-center p-4">
        <div class="glass-panel p-8 w-full max-w-sm relative text-left">
            <button onclick="closeAuthModal()" class="absolute top-4 right-4 text-slate-500 hover:text-white"><i class="fas fa-times"></i></button>
            <h3 id="auth-modal-title" class="text-xl font-bold mb-6 text-white text-center" data-i18n="sec_modal_title">安全驗證</h3>
            
            <div id="modal-content-pass" class="space-y-4 hidden">
                <input type="password" id="modal-old-pass" data-i18n-placeholder="old_ps" placeholder="舊密碼">
                <input type="password" id="modal-new-pass" data-i18n-placeholder="new_ps" placeholder="新密碼">
                <input type="password" id="modal-confirm-pass" data-i18n-placeholder="cfm_ps" placeholder="確認新密碼">
                <div class="flex justify-center pt-2">
                    <button onclick="submitAuthChange('pass')" class="w-48 bg-status-danger text-white font-bold py-3 rounded-lg hover:bg-red-600 shadow-lg" data-i18n="btn_save_red">確認修改</button>
                </div>
            </div>
            <div id="modal-content-id" class="space-y-4 hidden">
                <input type="text" id="modal-new-id" data-i18n-placeholder="new_uid" placeholder="新帳號 ID">
                <div class="flex justify-center pt-2">
                    <button onclick="submitAuthChange('id')" class="w-48 bg-primary-cyan text-slate-900 font-bold py-3 rounded-lg" data-i18n="btn_save">確認修改</button>
                </div>
            </div>
        </div>
    </div>

    <div id="camera-overlay" class="hidden fixed inset-0 z-[200] bg-black flex flex-col items-center justify-center">
        <video id="webcam-video" autoplay playsinline muted class="absolute inset-0 w-full h-full object-cover"></video>
        <div class="absolute inset-0 pointer-events-none">
            <div class="w-full h-1 bg-primary-cyan/50 shadow-[0_0_15px_rgba(34,211,238,0.8)] animate-scan-line"></div>
            <div id="scan-status-text" class="absolute top-20 left-1/2 transform -translate-x-1/2 bg-black/60 px-6 py-2 rounded-full border border-primary-cyan/50 text-primary-cyan text-xs md:text-sm whitespace-nowrap" data-i18n="cam_prompt">對準臉部引導框</div>
        </div>
        <button onclick="stopCamera()" class="absolute bottom-10 bg-red-500 text-white px-8 py-3 rounded-full font-bold z-50 text-sm md:text-base" data-i18n="reg_back_btn">停止掃描</button>
    </div>

    <div id="mobile-menu" class="hidden fixed inset-0 z-[4000] bg-slate-950 flex flex-col p-6 animate-fade-in">
        <div class="flex justify-end mb-10"><button onclick="toggleMobileMenu()" class="text-white text-2xl"><i class="fas fa-times"></i></button></div>
        <div id="mobile-nav-links" class="flex flex-col gap-6 text-center text-xl font-bold"></div>
        <button onclick="logout()" class="mt-auto py-4 text-red-400 border-t border-white/10"><i class="fas fa-sign-out-alt mr-2"></i>Logout</button>
    </div>

    <script>
        const i18n = {
            zh: { 
                login_title: "智慧鏡健康監測", login_subtitle: "AI 鏡頭生理數據分析", login_user_placeholder: "帳號 ID / admin", login_btn: "登入系統", login_forgot: "忘記密碼？", login_create_btn: "建立帳號", reg_complete_btn: "完成註冊並登入", reg_back_btn: "返回", no_acc: "沒有帳號？",
                dash_header: "健康總覽", mi_risk_title: "心肌梗塞風險", edema_title: "肢體水腫等級", common_today: "今日", start_scan_btn: "啟動 AI 鏡像檢測", sos_btn: "緊急求救 (SOS)",
                history_header: "生理數據追蹤", th_date: "日期", th_mi: "MI 指數", th_edema: "水腫等級", th_hr: "心率", th_bp: "血壓", th_action: "操作", range_1w: "一週", range_1m: "一個月", btn_custom: "自訂日期", btn_apply: "套用", btn_export: "匯出 CSV",
                profile_header: "使用者檔案", p_nm: "姓名", p_gd: "性別", p_ht: "身高", p_wt: "體重", p_bh: "生日", p_id: "帳號 ID", p_ps: "密碼", opt_male: "男", opt_female: "女", 
                nav_dashboard: "儀表總覽", nav_history: "歷史紀錄", nav_profile: "個人設定", nav_admin: "帳號管理", nav_logout: "登出系統",
                sec_title: "帳號安全設定", btn_change_id: "更改使用者 ID", btn_change_ps: "更改密碼", sec_modal_title: "安全驗證", old_ps: "舊密碼", new_uid: "新帳號 ID", new_ps: "新密碼", cfm_ps: "確認新密碼", btn_save: "儲存資料", btn_save_red: "確認修改", btn_cancel: "取消",
                cam_prompt: "對準臉部引導框", set_uid: "設定 ID", set_ps: "設定密碼", prof_name: "姓名", prof_gender: "性別", admin_select_user: "切換對象："
            },
            en: { 
                login_title: "Mirror Health", login_subtitle: "AI Face Vitals Scan", login_user_placeholder: "ID / admin", login_btn: "Login", login_forgot: "Forgot?", login_create_btn: "Sign Up", reg_complete_btn: "Register Now", reg_back_btn: "Back", no_acc: "No account?",
                dash_header: "Overview", mi_risk_title: "MI Risk Index", edema_title: "Edema Level", common_today: "Today", start_scan_btn: "Start AI Scan", sos_btn: "SOS EMERGENCY",
                history_header: "Health Tracking", th_date: "Date", th_mi: "MI %", th_edema: "Level", th_hr: "HR", th_bp: "BP", th_action: "Action", range_1w: "1W", range_1m: "1M", btn_custom: "Custom", btn_apply: "Apply", btn_export: "Export",
                profile_header: "Profile", p_nm: "Name", p_gd: "Gender", p_ht: "Height", p_wt: "Weight", p_bh: "Birth", p_id: "ID", p_ps: "Pass", opt_male: "Male", opt_female: "Female",
                nav_dashboard: "Dashboard", nav_history: "History", nav_profile: "Settings", nav_admin: "Admin", nav_logout: "Sign Out",
                sec_title: "Security", btn_change_id: "Change ID", btn_change_ps: "Change Password", sec_modal_title: "Verification", old_ps: "Old Pass", new_uid: "New ID", new_ps: "New Password", cfm_ps: "Confirm", btn_save: "Save", btn_save_red: "Update", btn_cancel: "Cancel",
                cam_prompt: "Align with guide", set_uid: "Set ID", set_ps: "Set Pass", prof_name: "Name", prof_gender: "Gender", admin_select_user: "Target User:"
            }
        };

        let userDataMap = JSON.parse(localStorage.getItem('health_db_v15_final')) || {
            "admin": { name: "Admin", pass: "1234", role: "admin", history: [] },
            "user": { name: "Sample User", pass: "0000", role: "user", gender: "female", birth: "1995-05-20", height: 165, weight: 55, history: [] }
        };

        if(!userDataMap["user"].history.length) {
            for(let i=0; i<15; i++) userDataMap["user"].history.push({ date: `2025-12-${22-i}`, mi: 12, edema: 1, hr: 75, hrv: 50, bp: "120/80" });
        }

        let currentLang = 'zh', loggedInUser = '', activeUserId = '', chartInstance = null, videoStream = null;

        function handleLogin() {
            const id = document.getElementById('login-user').value.trim(), ps = document.getElementById('login-pass').value;
            if (userDataMap[id] && userDataMap[id].pass === ps) loginSuccess(id);
            else alert("Error");
        }

        function handleRegister() {
            const id = document.getElementById('reg-id').value.trim(), ps = document.getElementById('reg-pass').value, nm = document.getElementById('reg-name').value;
            if(!id || !ps || !nm) return alert("Empty");
            userDataMap[id] = { name: nm, pass: ps, role: "user", gender: document.getElementById('reg-gender').value, birth: document.getElementById('reg-birth').value, height: document.getElementById('reg-height').value, weight: document.getElementById('reg-weight').value, history: [] };
            saveData(); loginSuccess(id);
        }

        function loginSuccess(uid) {
            loggedInUser = uid; activeUserId = uid;
            document.getElementById('login-view').classList.add('hidden');
            setupApp();
        }

        function setupApp() {
            const u = userDataMap[loggedInUser], nav = document.getElementById('sidebar-nav'), mobileNav = document.getElementById('mobile-nav-links');
            document.getElementById('display-name').innerText = u.name;
            document.getElementById('display-name-mobile').innerText = u.name;
            document.getElementById('display-id').innerText = "ID: " + loggedInUser;
            const isAdmin = u.role === 'admin';
            document.getElementById('role-badge').innerText = u.role.toUpperCase();
            
            let btnHtml = "";
            if(isAdmin) {
                btnHtml = `<button onclick="navTo('admin-manage')" id="nav-admin-manage" class="w-full flex items-center gap-3 p-4 nav-btn-active"><i class="fas fa-users-cog"></i> <span data-i18n="nav_admin"></span></button><button onclick="navTo('history')" id="nav-history" class="w-full flex items-center gap-3 p-4 nav-btn-inactive"><i class="fas fa-history"></i> <span data-i18n="nav_history"></span></button>`;
                navTo('admin-manage');
            } else {
                btnHtml = `<button onclick="navTo('dashboard')" id="nav-dashboard" class="w-full flex items-center gap-3 p-4 nav-btn-active"><i class="fas fa-chart-line"></i> <span data-i18n="nav_dashboard"></span></button><button onclick="navTo('history')" id="nav-history" class="w-full flex items-center gap-3 p-4 nav-btn-inactive"><i class="fas fa-history"></i> <span data-i18n="nav_history"></span></button><button onclick="navTo('profile')" id="nav-profile" class="w-full flex items-center gap-3 p-4 nav-btn-inactive"><i class="fas fa-user-cog"></i> <span data-i18n="nav_profile"></span></button>`;
                navTo('dashboard');
            }
            nav.innerHTML = btnHtml; mobileNav.innerHTML = btnHtml;
            setLanguage(currentLang);
        }

        function setLanguage(l) {
            currentLang = l;
            const data = i18n[l];
            document.querySelectorAll('[data-i18n]').forEach(el => { const k = el.getAttribute('data-i18n'); if(data[k]) el.innerText = data[k]; });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => { const k = el.getAttribute('data-i18n-placeholder'); if(data[k]) el.placeholder = data[k]; });
            document.getElementById('btn-zh').className = l === 'zh' ? 'lang-btn lang-btn-active' : 'lang-btn lang-btn-inactive';
            document.getElementById('btn-en').className = l === 'en' ? 'lang-btn lang-btn-active' : 'lang-btn lang-btn-inactive';
        }

        function navTo(v) {
            document.querySelectorAll('.subview').forEach(e => e.classList.add('hidden')); 
            document.getElementById(`view-${v}`).classList.remove('hidden');
            document.querySelectorAll('nav button, #mobile-nav-links button').forEach(b => b.classList.replace('nav-btn-active', 'nav-btn-inactive'));
            document.querySelectorAll(`[id$="${v}"]`).forEach(b => b.classList.replace('nav-btn-inactive', 'nav-btn-active'));
            if(v==='dashboard') updateDashboard(); if(v==='history') applyTimeRange(30);
            document.getElementById('mobile-menu').classList.add('hidden');
        }

        function startCamera() {
            document.getElementById('camera-overlay').classList.remove('hidden');
            navigator.mediaDevices.getUserMedia({ video: true }).then(s => {
                videoStream = s; document.getElementById('webcam-video').srcObject = s;
                setTimeout(() => {
                    const entry = { date: new Date().toISOString().split('T')[0], mi: 12, edema: 1, hr: 72, hrv: 45, bp: "124/82" };
                    userDataMap[loggedInUser].history.unshift(entry); saveData(); stopCamera(); updateDashboard();
                }, 3000);
            });
        }
        function stopCamera() { document.getElementById('camera-overlay').classList.add('hidden'); if(videoStream) videoStream.getTracks().forEach(t => t.stop()); }
        function toggleMobileMenu() { document.getElementById('mobile-menu').classList.toggle('hidden'); }
        function updateDashboard() {
            const h = userDataMap[activeUserId].history;
            document.getElementById('dash-mi-value').innerText = h.length ? h[0].mi + "%" : "--";
            document.getElementById('dash-edema-value').innerText = h.length ? "Lv." + h[0].edema : "--";
            document.getElementById('dash-hr').innerText = h.length ? h[0].hr : "--";
            document.getElementById('dash-hrv').innerText = h.length ? h[0].hrv : "--";
            document.getElementById('dash-bp').innerText = h.length ? h[0].bp : "--";
        }

        function applyTimeRange(d, b) { if(b) { document.querySelectorAll('#range-selector button').forEach(x => x.classList.remove('range-btn-active')); b.classList.add('range-btn-active'); } renderChart(userDataMap[activeUserId].history.slice(0, d)); }
        function renderChart(data) {
            const ctx = document.getElementById('historyChart').getContext('2d'); if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, { type: 'line', data: { labels: data.map(x=>x.date.slice(5)), datasets: [{ label: 'Vitals', data: data.map(x=>x.mi), borderColor: '#22d3ee', fill: true }] }, options: { responsive: true, maintainAspectRatio: false } });
            document.getElementById('history-table-body').innerHTML = data.map(r => `<tr><td class="p-3 md:p-4">${r.date}</td><td class="p-3 md:p-4 text-cyan-400 font-bold">${r.mi}%</td><td class="p-3 md:p-4 text-amber-500 font-bold">Lv.${r.edema}</td><td class="p-3 md:p-4">${r.hr}</td><td class="p-3 md:p-4">${r.hrv}</td><td class="p-3 md:p-4">${r.bp}</td></tr>`).join('');
        }
        function openAuthModal(t) { document.getElementById('auth-modal').classList.remove('hidden'); document.getElementById('modal-content-pass').classList.toggle('hidden', t!=='pass'); document.getElementById('modal-content-id').classList.toggle('hidden', t!=='id'); }
        function closeAuthModal() { document.getElementById('auth-modal').classList.add('hidden'); }
        function toggleLoginRegister(on) { document.getElementById('login-form').classList.toggle('hidden', on); document.getElementById('register-form').classList.toggle('hidden', !on); }
        function logout() { location.reload(); }
        function saveData() { localStorage.setItem('health_db_v15_final', JSON.stringify(userDataMap)); }
        function triggerSOS() { alert("SOS!"); }
        setInterval(() => { document.getElementById('clock-display').innerText = new Date().toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit' }); }, 1000);
        document.addEventListener('DOMContentLoaded', () => setLanguage('zh'));
    </script>
</body>
</html>
